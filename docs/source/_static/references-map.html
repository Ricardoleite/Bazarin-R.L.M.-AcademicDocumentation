<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Reference Graph (Year vs Citations)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  html, body { margin:0; height:100%; font-family: Inter, system-ui, Arial, sans-serif; }
  #toolbar { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #e0e0e0; border-radius:12px; padding:12px; z-index:10; box-shadow:0 2px 10px rgba(0,0,0,.08); max-width:360px;}
  #graph { width:100%; height:100%; }
  .node text { pointer-events:none; font-size:12px; fill:#fff; text-shadow: 0px 0px 3px rgba(0,0,0,0.7);}
  .link { stroke:#cfd8dc; stroke-opacity:.8; }
  .node circle { stroke:#fff; stroke-width:1.5px; }
  .tooltip {
    position:absolute; pointer-events:none; background:#111; color:#fff; padding:8px 10px;
    border-radius:8px; font-size:12px; line-height:1.4; box-shadow:0 2px 10px rgba(0,0,0,.2);
  }
  a.tooltip-link { color:#4fc3f7; }
  .row { display:flex; gap:6px; align-items:center; margin-top:6px; flex-wrap:wrap; }
  .row label { font-size:12px; color:#333; }
  input[type="number"] { width:96px; }
  textarea { width:100%; height:100px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; }
  button { cursor:pointer; }
  .legend { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
  .legend-item { display:flex; align-items:center; gap:6px; font-size:12px; }
  .swatch { width:12px; height:12px; border-radius:50%; border:1px solid #999; }
  /* collapsible toolbar */
  #toolbar.collapsed #toolbar-content { display: none; }
  #toggleToolbar {
    background:#eee;
    border:1px solid #ccc;
    border-radius:4px;
  }
</style>
</head>
<body>
<div id="toolbar">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div style="font-weight:700;">Reference Graph</div>
    <button id="toggleToolbar" style="font-size:12px; padding:2px 6px; cursor:pointer;">–</button>
  </div>
  <div id="toolbar-content">
    <div style="font-size:12px; color:#555; line-height:1.3; margin-top:4px;">
      x = year • y = citations • bubble size ≈ citations
    </div>

    <div class="row" style="margin-top:8px;">
      <label>Year range:</label>
      <input id="minY" type="number" value="2010">
      <span>–</span>
      <input id="maxY" type="number" value="2030">
      <button id="apply">Filter</button>
    </div>

    <div class="row">
      <label>Load nodes CSV</label>
      <input id="nodesCSV" type="file" accept=".csv">
    </div>
    <div class="row" style="font-size:11px; color:#666;">
      Expected columns: id,label,author,year,citations,url,group,notes
    </div>

    <div class="row">
      <label>Load links CSV</label>
      <input id="linksCSV" type="file" accept=".csv">
    </div>
    <div class="row" style="font-size:11px; color:#666;">Expected columns: source,target,weight</div>

    <details style="margin-top:8px;">
      <summary style="cursor:pointer;">Or edit JSON here (then click “Reload from JSON”)</summary>
      <div style="margin-top:6px; font-weight:600; font-size:12px;">nodes JSON</div>
      <textarea id="nodesJSON">[
  {"id":"Meng2016","label":"Meng, 2016","author":"Meng","year":2016,"citations":41,"group":"LBM-Multiscale","url":"https://doi.org/10.1016/j.ijheatmasstransfer.2016.04.095","notes":"Linear Convective-Diffusive"},
  {"id":"Baz2024","label":"Bazarin, 2024","author":"Bazarin","year":2024,"citations":1,"group":"Your work","url":"https://doi.org/10.1103/PhysRevE.110.015303","notes":"Multicomponent numerical modeling"},
  {"id":"Baz2025","label":"Bazarin, 2025","author":"Bazarin","year":2025,"citations":2,"group":"LBM-Multiscale","url":"https://doi.org/10.1063/5.0264878","notes":"Dynamic capillary"}
]</textarea>
      <div style="font-weight:600; font-size:12px;">links JSON</div>
      <textarea id="linksJSON">[
  {"source":"Meng2016","target":"Baz2025","weight":1}
]</textarea>
      <button id="reloadJSON" style="margin-top:6px;">Reload from JSON</button>
    </details>

    <div class="legend" id="legend"></div>
  </div> <!-- closes #toolbar-content -->
</div> <!-- ✅ closes #toolbar (this was missing) -->

<svg id="graph"></svg>
<div id="tooltip" class="tooltip" style="display:none;"></div>

<script>
// ======= Color mapping by group =======
const GROUP_COLORS = {
  "LBM BCs":"#e74c3c",
  "LBM multiphase":"#27ae60",
  "LBM-Multiscale":"#2ecc71",
  "LBM theory":"#1abc9c",
  "Applications":"#9b59b6",
  "Your work":"#00bcd4"
};

// ======= State =======
let nodes = JSON.parse(document.getElementById("nodesJSON").value);
let links = JSON.parse(document.getElementById("linksJSON").value);

// ======= Chart bootstrap =======
const svg = d3.select('#graph');
const width = window.innerWidth;
const height = window.innerHeight;
svg.attr('width', width).attr('height', height);

const gLinks = svg.append('g');
const gNodes = svg.append('g');

// Tooltip
const tooltip = document.getElementById('tooltip');
function showTip(event, d) {
  tooltip.style.display = 'block';
  tooltip.innerHTML = `<b>${d.label}</b><br>Author: ${d.author}<br>Year: ${d.year}<br>
                       Citations: ${d.citations}<br>Group: ${d.group}<br>${d.notes || ""}
                       <br><a class="tooltip-link" href="${d.url}" target="_blank">Open DOI/URL</a>`;
  tooltip.style.left = (event.pageX + 12) + 'px';
  tooltip.style.top  = (event.pageY + 12) + 'px';
}
function hideTip() { tooltip.style.display = 'none'; }

// Build graph
function buildGraph() {
  nodes.forEach(d => {
    d.citations = +d.citations;
    d.year = +d.year;
    d.r = 10 + Math.sqrt(Math.max(d.citations, 0)) * 3.5;
    d.color = GROUP_COLORS[d.group] || '#95a5a6';
  });

  const yearExtent = d3.extent(nodes, d => d.year);
  const citExtent  = d3.extent(nodes, d => d.citations);

  // Centered scales (no axes)
  const x = d3.scaleLinear().domain(yearExtent).range([width*0.25, width*0.75]);
  const y = d3.scaleLinear().domain(citExtent).range([height*0.75, height*0.25]);

  gLinks.selectAll('*').remove();
  gNodes.selectAll('*').remove();

  const linkSel = gLinks.selectAll('line')
    .data(links)
    .enter().append('line')
    .attr('class','link')
    .attr('stroke','#cfd8dc')
    .attr('stroke-width', d=> 0.8 + (+d.weight || 0));

  const nodeSel = gNodes.selectAll('g.node')
    .data(nodes, d => d.id)
    .enter().append('g')
    .attr('class','node');

  nodeSel.append('circle')
    .attr('r', d=>d.r)
    .attr('fill', d=>d.color)
    .on('mouseover', showTip)
    .on('mouseout', hideTip)
    .on('click', (ev,d)=> d.url && window.open(d.url, '_blank'));

  nodeSel.append('text')
    .attr('text-anchor','middle')
    .attr('dy', d=> d.r + 14)
    .text(d=> d.label);

  // Simulation toward scatter coordinates (centered)
  const byId = new Map(nodes.map(d => [d.id, d]));
  const getNode = s => (typeof s === 'object') ? s : byId.get(s);

  const sim = d3.forceSimulation(nodes)
    .force('x', d3.forceX(d => x(d.year)).strength(1))
    .force('y', d3.forceY(d => y(d.citations)).strength(1))
    .force('collide', d3.forceCollide().radius(d => d.r + 2))
    .alpha(1)
    .on('tick', () => {
      nodeSel.attr('transform', d => `translate(${d.x}, ${d.y})`);
      linkSel
        .attr('x1', d => getNode(d.source).x)
        .attr('y1', d => getNode(d.source).y)
        .attr('x2', d => getNode(d.target).x)
        .attr('y2', d => getNode(d.target).y);
    });
}

// Toggle toolbar collapse/expand
document.getElementById('toggleToolbar').addEventListener('click', () => {
  const tb = document.getElementById('toolbar');
  tb.classList.toggle('collapsed');
  document.getElementById('toggleToolbar').textContent =
    tb.classList.contains('collapsed') ? '+' : '–';
});

// Initial draw
buildGraph();
</script>
</body>
</html>
